<!DOCTYPE html>
<html>
<head>
    <meta charset = "UTF-8">
    <title>Lit map</title>
</head>
<body>

<script src = "https://api-maps.yandex.ru/2.1?apikey=93dac595-75c2-4d3f-a5ed-6ef51f8745ac&lang=ru_RU"></script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@beta/dist/js.cookie.min.js"></script>
<script src = "sendGetPost.js"></script>
<script src = "bigJSON.js"></script>

<a href = "index.html">Режим 1</a>
<br>
<a href = "page2.html">Режим 2</a>

<h1>Lit map</h1>

<h2 id = "loginBox"></h2>

<div id = "youAuthedOKbox" hidden>
    <h3>Режим 2</h3>
    <div id = "myMap" style = "width: 700px; height: 500px"></div>
</div>

<script>
    "use strict";

    function continueWork() {
        console.log("continueWork call");
        let persons_arr = JSON.parse(json_full).data.persons;
        let myMap = new ymaps.Map('myMap', {
            center: [59.939095, 30.315868],
            zoom: 14,
            controls: ['zoomControl', 'typeSelector',  'fullscreenControl'],
        });
        //myMap.setBounds([[37, 38], [39, 40]]);
        var myGeoObjects = new ymaps.GeoObjectCollection({}, {
            preset: "islands#redCircleIcon",
            strokeWidth: 4,
            geodesic: true
        });
        for (let i = 0; i < persons_arr.length; i++) {
        let person = persons_arr[i];
        const relations_arr = person.relations;
        console.log(relations_arr)
        for (let j = 0; j < relations_arr.length; j++) {
            let location = relations_arr[j].location
            if (location) {
                let x = location.coordinateX;
                let y = location.coordinateY;
                let  short_description = '';
                if (location.description.ru) {
                    let description = location.description.ru;
                    short_description = description.slice(0,30);
                }
                myGeoObjects.add(new ymaps.Placemark([x, y],
                    {balloonContent: `<b>${location.name.ru}</b><br><i>${person.firstName.ru} ${person.lastName.ru}</i><p>${short_description} ...</p><a href="${location.wikiLink}">Подробнее</a>`,}));
                }
            }
        }
        myMap.geoObjects.add(myGeoObjects);
        //myMap.setBounds(myGeoObjects.getBounds());
    }

    window.onload = function() {
        sendGet("/api/users/me/", (text, status) => { 
            if(status === 200) {
                document.getElementById("loginBox").innerHTML = "Авторизован: " + JSON.parse(text).username;
                document.getElementById("youAuthedOKbox").hidden = false;
                continueWork();
            } else {
                document.getElementById("loginBox").innerHTML = "Вы не авторизованы";
            }
        });
    }
</script>

</body>
</html>
